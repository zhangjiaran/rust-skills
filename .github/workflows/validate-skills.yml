name: Validate Skills

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

# Minimal read-only permissions for all jobs
permissions:
  contents: read

jobs:
  # ──────────────────────────────────────────────
  # Job 1: Verify every required skill file exists
  # and is non-empty
  # ──────────────────────────────────────────────
  validate-files:
    name: Validate Required Files
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check required skill files exist and are non-empty
        run: |
          set -e
          REQUIRED_FILES=(
            ".github/copilot-instructions.md"
            ".cursorrules"
            "README.md"
            "skills/rust-installation/SKILL.md"
            "skills/rust-development/SKILL.md"
            "skills/rust-unit-testing/SKILL.md"
            "skills/rust-code-check/SKILL.md"
            "skills/rust-cargo-build/SKILL.md"
          )
          FAILED=0
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "❌ Missing required file: $file"
              FAILED=1
            elif [ ! -s "$file" ]; then
              echo "❌ File is empty: $file"
              FAILED=1
            else
              echo "✅ $file"
            fi
          done
          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "One or more required skill files are missing or empty."
            exit 1
          fi
          echo ""
          echo "All required skill files are present and non-empty."

  # ──────────────────────────────────────────────
  # Job 2: Lint all Markdown files
  # ──────────────────────────────────────────────
  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Lint Markdown files
        uses: DavidAnson/markdownlint-cli2-action@v16
        with:
          globs: "**/*.md"

  # ──────────────────────────────────────────────
  # Job 3: Verify internal links in README.md
  # resolve to actual files in the repo
  # ──────────────────────────────────────────────
  check-links:
    name: Check Internal Links
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Verify README internal file links
        run: |
          set -e
          echo "Checking internal file links in README.md..."
          FAILED=0
          # Extract relative file paths from markdown links: [text](path)
          # Only check paths that do NOT start with http/https/#
          while IFS= read -r link; do
            # Strip fragment (#section)
            target="${link%%#*}"
            [ -z "$target" ] && continue
            if [ ! -e "$target" ]; then
              echo "❌ Broken link: $target"
              FAILED=1
            else
              echo "✅ $target"
            fi
          done < <(grep -oP '\[.*?\]\(\K[^)]+' README.md | grep -v '^https\?://' | grep -v '^http://' | grep -v '^#')
          if [ "$FAILED" -eq 1 ]; then
            echo ""
            echo "One or more internal links in README.md are broken."
            exit 1
          fi
          echo ""
          echo "All internal links in README.md are valid."
